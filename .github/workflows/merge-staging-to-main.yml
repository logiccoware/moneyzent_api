name: Merge staging to main

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: merge-staging-to-main
  cancel-in-progress: true

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create/update PR and enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_BRANCH: main
          HEAD_BRANCH: staging
        run: |
          set -euo pipefail

          git fetch origin "${BASE_BRANCH}" "${HEAD_BRANCH}"

          if git diff --quiet "origin/${BASE_BRANCH}...origin/${HEAD_BRANCH}"; then
            echo "No changes to merge from ${HEAD_BRANCH} to ${BASE_BRANCH}."
            exit 0
          fi

          PR_NUMBER="$(gh pr list \
            --base "${BASE_BRANCH}" \
            --head "${HEAD_BRANCH}" \
            --state open \
            --json number \
            --jq '.[0].number')"

          if [ -z "${PR_NUMBER}" ] || [ "${PR_NUMBER}" = "null" ]; then
            PR_URL="$(gh pr create \
              --base "${BASE_BRANCH}" \
              --head "${HEAD_BRANCH}" \
              --title "Merge ${HEAD_BRANCH} into ${BASE_BRANCH}" \
              --body "Automated PR to merge \`${HEAD_BRANCH}\` into \`${BASE_BRANCH}\`." )"
            PR_NUMBER="$(gh pr view "${PR_URL}" --json number --jq '.number')"
          fi

          gh pr merge "${PR_NUMBER}" --merge --auto
