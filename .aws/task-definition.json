{
  "family": "prod-monovra-api",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "executionRoleArn": "arn:aws:iam::283941296486:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::283941296486:role/ecsTaskRole",
  "containerDefinitions": [
    {
      "name": "log_router",
      "image": "amazon/aws-for-fluent-bit:stable",
      "essential": true,
      "firelensConfiguration": {
        "type": "fluentbit",
        "options": {
          "enable-ecs-log-metadata": "true"
        }
      },
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/prod-monovra-api-firelens",
          "awslogs-region": "us-east-1",
          "awslogs-stream-prefix": "firelens",
          "awslogs-create-group": "true"
        }
      },
      "memoryReservation": 50
    },
    {
      "name": "monovra-api",
      "image": "283941296486.dkr.ecr.us-east-1.amazonaws.com/prod-monovra-api:latest",
      "essential": true,
      "portMappings": [
        {
          "containerPort": 3000,
          "protocol": "tcp"
        }
      ],
      "healthCheck": {
        "command": [
          "CMD-SHELL",
          "node -e \"fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))\""
        ],
        "interval": 30,
        "timeout": 10,
        "retries": 3,
        "startPeriod": 60
      },
      "environment": [
        {
          "name": "NODE_ENV",
          "value": "production"
        },
        {
          "name": "APP_ENV",
          "value": "production"
        },
        {
          "name": "PORT",
          "value": "3000"
        },
        {
          "name": "OTEL_TRACES_EXPORTER",
          "value": "otlp"
        },
        {
          "name": "OTEL_EXPORTER_OTLP_ENDPOINT",
          "value": "https://otlp-gateway-prod-ca-east-0.grafana.net/otlp"
        },
        {
          "name": "OTEL_RESOURCE_ATTRIBUTES",
          "value": "service.name=moneyzent-api,service.namespace=moneyzent"
        },
        {
          "name": "OTEL_NODE_RESOURCE_DETECTORS",
          "value": "env,host,os"
        },
        {
          "name": "NODE_OPTIONS",
          "value": "--require @opentelemetry/auto-instrumentations-node/register"
        }
      ],
      "secrets": [
        {
          "name": "DATABASE_URL",
          "valueFrom": "arn:aws:secretsmanager:us-east-1:283941296486:secret:prod/monovra/database-url-KbawNp"
        },
        {
          "name": "BETTER_AUTH_SECRET",
          "valueFrom": "arn:aws:secretsmanager:us-east-1:283941296486:secret:prod/monovra/better-auth-secret-zvQ4vZ"
        },
        {
          "name": "BETTER_AUTH_URL",
          "valueFrom": "arn:aws:ssm:us-east-1:283941296486:parameter/monovra/prod/better-auth-url"
        },
        {
          "name": "CORS_ORIGIN",
          "valueFrom": "arn:aws:ssm:us-east-1:283941296486:parameter/monovra/prod/cors-origin"
        },
        {
          "name": "DATABASE_POOL_SIZE",
          "valueFrom": "arn:aws:ssm:us-east-1:283941296486:parameter/monovra/prod/database-pool-size"
        },
        {
          "name": "OTEL_EXPORTER_OTLP_HEADERS",
          "valueFrom": "arn:aws:ssm:us-east-1:283941296486:parameter/monovra/prod/otel-exporter-headers"
        }
      ],
      "logConfiguration": {
        "logDriver": "awsfirelens",
        "options": {
          "Name": "loki",
          "Host": "logs-prod-018.grafana.net",
          "Port": "443",
          "tls": "on",
          "labels": "job=moneyzent-api,env=production",
          "remove_keys": "container_id,ecs_task_arn",
          "label_keys": "$container_name,$ecs_task_definition,$ecs_cluster"
        },
        "secretOptions": [
          {
            "name": "HTTP_User",
            "valueFrom": "arn:aws:secretsmanager:us-east-1:283941296486:secret:prod/monovra/grafana-loki-credentials-2PU5u1:user::"
          },
          {
            "name": "HTTP_Passwd",
            "valueFrom": "arn:aws:secretsmanager:us-east-1:283941296486:secret:prod/monovra/grafana-loki-credentials-2PU5u1:password::"
          }
        ]
      }
    }
  ]
}
